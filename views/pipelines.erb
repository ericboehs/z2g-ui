<%= erb :_progress_nav, locals: { steps: steps } %>
<div class="min-h-full flex flex-col justify-center py-12 sm:px-6 lg:px-8">
  <% if @workspace %>
    <div class="sm:mx-auto sm:w-full sm:max-w-4xl">
      <div class="flex justify-between items-center mb-6">
        <h2 class="text-2xl font-bold">Pick Statuses for <%= @workspace["displayName"] %> Pipelines</h2>
        <div class="flex gap-4">
          <a href="/clear-cache" class="inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">
            <svg class="w-4 h-4 mr-1" viewBox="0 0 24 24" fill="none" stroke="currentColor">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Refresh
          </a>
        </div>
      </div>
      <div class="flex justify-between items-center mb-4">
        <div class="flex gap-4 text-sm text-gray-600">
          <a href="<%= params[:workspace_url] %>" target="_blank" class="hover:text-gray-900 flex items-center gap-1">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
              <path d="M10 6V8H5V19H16V14H18V20C18 20.5523 17.5523 21 17 21H4C3.44772 21 3 20.5523 3 20V7C3 6.44772 3.44772 6 4 6H10ZM21 3V11H19L18.9999 6.413L11.2071 14.2071L9.79289 12.7929L17.5849 5H13V3H21Z"/>
            </svg>
            ZenHub Workspace
          </a>
          <a href="<%= params[:github_url] %>" target="_blank" class="hover:text-gray-900 flex items-center gap-1">
            <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
              <path d="M10 6V8H5V19H16V14H18V20C18 20.5523 17.5523 21 17 21H4C3.44772 21 3 20.5523 3 20V7C3 6.44772 3 6 4 6H10ZM21 3V11H19L18.9999 6.413L11.2071 14.2071L9.79289 12.7929L17.5849 5H13V3H21Z"/>
            </svg>
            GitHub Project
          </a>
        </div>
        <a href="<%= params[:github_url] %>/settings/fields/<%= @github_status_field&.dig('name') %>" 
           target="_blank" 
           class="text-sm text-gray-600 hover:text-gray-900 flex items-center gap-1">
          <svg class="w-4 h-4" viewBox="0 0 24 24" fill="currentColor">
            <path d="M10 6V8H5V19H16V14H18V20C18 20.5523 17.5523 21 17 21H4C3.44772 21 3 20.5523 3 20V7C3 6.44772 3 6 4 6H10ZM21 3V11H19L18.9999 6.413L11.2071 14.2071L9.79289 12.7929L17.5849 5H13V3H21Z"/>
          </svg>
          Need to add a Status?
        </a>
      </div>
      <div class="bg-white shadow rounded-lg overflow-hidden">
        <table class="min-w-full divide-y divide-gray-300">
          <thead class="bg-gray-50">
            <tr>
              <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900">ZenHub Pipeline</th>
              <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">GitHub Status</th>
            </tr>
          </thead>
          <tbody class="divide-y divide-gray-200">
            <% @workspace["pipelines"].each do |pipeline| %>
              <tr class="hover:bg-gray-50 cursor-pointer" onclick="toggleAccordion('<%= pipeline["id"] %>')">
                <td class="whitespace-nowrap py-4 pl-4 pr-3 text-sm">
                  <div class="flex items-center">
                    <div class="flex items-center flex-1">
                      <svg id="arrow-<%= pipeline["id"] %>" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 transition-transform duration-200 mr-2">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m8.25 4.5 7.5 7.5-7.5 7.5" />
                      </svg>
                      <span class="font-medium text-gray-900"><%= pipeline["name"] %></span>
                      <span class="text-gray-500 ml-2">(<%= @pipeline_data[pipeline["id"]][:count] %> issues)</span>
                    </div>
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-4 text-gray-400 mr-16">
                      <path stroke-linecap="round" stroke-linejoin="round" d="M13.5 4.5 21 12m0 0-7.5 7.5M21 12H3" />
                    </svg>
                  </div>
                </td>
                <td class="whitespace-nowrap px-3 py-4 text-sm">
                  <div class="flex items-center justify-between">
                    <select class="block w-full rounded-md border-0 py-1.5 pl-3 pr-10 text-gray-900 ring-1 ring-inset ring-gray-300 focus:ring-2 focus:ring-indigo-600 sm:text-sm/6" 
                          onclick="event.stopPropagation()"
                          onchange="handleSprintSelect(this)">
                    <% 
                      max_distance = 3
                      closest_option, distance = @github_status_options.map { |option| [option, DidYouMean::Levenshtein.distance(pipeline["name"], option['name'])] }.min_by { |_, dist| dist }
                      closest_option = nil if distance > max_distance
                    %>
                    <% @github_status_options&.each do |option| %>
                      <option value="<%= option['id'] %>" <%= 'selected' if option == closest_option %>><%= option['name'] %></option>
                    <% end %>
                  </select>
                </td>
              </tr>
              <tr id="content-<%= pipeline["id"] %>" class="hidden">
                <td colspan="2" class="px-0 border-t border-gray-200">
                  <div class="overflow-x-auto">
                    <table class="min-w-full divide-y divide-gray-300">
                      <thead class="bg-gray-50">
                        <tr>
                          <th scope="col" class="py-3.5 pl-4 pr-3 text-left text-sm font-semibold text-gray-900 pl-8">Number</th>
                          <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">Title</th>
                          <th scope="col" class="px-3 py-3.5 text-left text-sm font-semibold text-gray-900">GitHub Status</th>
                        </tr>
                      </thead>
                      <tbody class="divide-y divide-gray-200 bg-white">
                        <% @pipeline_data[pipeline["id"]][:issues].each do |issue| %>
                          <tr class="issue-row">
                            <td class="whitespace-nowrap py-4 pl-8 pr-3 text-sm">
                              <a href="<%= issue["htmlUrl"] %>" target="_blank" class="text-blue-600 hover:text-blue-800">
                                #<%= issue["number"] %>
                              </a>
                            </td>
                            <td class="whitespace-normal px-3 py-4 text-sm text-gray-700">
                              <%= issue["title"] %>
                            </td>
                            <td class="whitespace-nowrap px-3 py-4 text-sm">
                              <%=
                                @github_issues.find do |gh_issue|
                                  gh_issue[:content][:url] == issue["htmlUrl"]
                                end&.dig(:fieldValues, :nodes)&.find { |node| node.dig(:field, :name) == "Status" }&.dig(:name)
                              %>
                            </td>
                          </tr>
                        <% end %>
                      </tbody>
                    </table>
                  </div>
                </td>
              </tr>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>
